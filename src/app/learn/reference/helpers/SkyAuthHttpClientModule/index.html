<stache
  pageTitle="SkyAuthHttpClientModule"
  showTableOfContents="true">

  <stache-page-summary>
    <p>
      <sky-code>SkyAuthHttpClientModule</sky-code> enables SKY UX SPAs to use <a href="https://angular.io/guide/http">Angular's <sky-code>HttpClient</sky-code> service</a> to make authenticated calls to Blackbaud services.
    </p>
  </stache-page-summary>

  <stache-page-anchor>
    Use <sky-code>SkyAuthHttpClientModule</sky-code> to communicate with backend services
  </stache-page-anchor>

  <ol>
    <li>
      <p>
        In a local editor, open the <sky-code>skyuxconfig.json</sky-code> file in the root directory and set <a stacheRouterLink="/learn/reference/configuration" fragment="auth">the <sky-code>auth</sky-code> configuration property</a> to <sky-code>true</sky-code>.
      </p>
      <sky-code-block languageType="json">
        {
          "auth": true
        }
      </sky-code-block>
    </li>
    <li>
      <p>
        Open the <sky-code>app-extras.module.ts</sky-code> file in the <sky-code>src/app</sky-code> directory. Import <sky-code>SkyAuthHttpClientModule</sky-code> from <sky-code>@skyux/http</sky-code> and add it to the Angular module’s <sky-code>exports</sky-code> section.
      </p>
      <sky-code-block languageType="typescript">
        import {
          SkyAuthHttpClientModule
        } from '@skyux/http';

        @NgModule({
          exports: [
            SkyAuthHttpClientModule
          ]
        })
        export class AppExtrasModule { }
      </sky-code-block>
    </li>
    <li>
      <p>
        Use the <sky-code>HttpClient</sky-code> service communicate with the Blackbaud web service. To ensure calls are authenticated using Blackbaud ID, pass in the result of <sky-code>skyAuthHttpOptions()</sky-code>, which is also defined in <sky-code>@skyux/http</sky-code>, as the <sky-code>options </sky-code> parameter to the <sky-code>HttpClient</sky-code> methods.
      </p>

      <sky-code-block languageType="typescript">
        import {
          Injectable
        } from '@angular/core';

        import {
          HttpClient
        } from '@angular/common/http';

        import {
          skyAuthHttpOptions
        } from '@skyux/http';

        @Injectable()
        export class FooService implements OnInit {

          constructor(private http: HttpClient) { }

          public getData() {
            // Available options are defined here:
            // https://github.com/blackbaud/skyux-http/blob/master/src/app/public/modules/auth-http-client/auth-options.ts#L20-L29
            const options: any = {};

            return this.http.get(
              'https://example.com/my/api/endpoint',
              skyAuthHttpOptions(options)
            );
          }
        }
      </sky-code-block>

      <p>
        When providing a type parameter to <sky-code>HttpClient</sky-code> methods (e.g. <sky-code>http.get&lt;Foo&gt;()</sky-code>), <sky-code>skyAuthHttpOptions()</sky-code> may cause TypeScript to incorrectly infer the return type. One way to fix this is to cast the result of <sky-code>skyAuthHttpOptions()</sky-code> to force the correct return type. Another way is if you are requesting JSON data and do not need to <a href="https://angular.io/guide/http#reading-the-full-response">read the full HTTP response</a>, you can use the <sky-code>skyAuthHttpJsonOptions()</sky-code> method, also defined in <sky-code>@skyux/http</sky-code>, instead.
      </p>

      <sky-code-block languageType="typescript">
        // TypeScript will infer a return type of `Observable&lt;HttpEvent&lt;Foo&gt;&gt;`
        this.http.get&lt;Foo&gt;(
          'https://example.com/my/api/endpoint',
          skyAuthHttpOptions()
        );

        // TypeScript will infer a return type of `Observable&lt;Foo&gt;`
        this.http.get&lt;Foo&gt;(
          'https://example.com/my/api/endpoint',
          skyAuthHttpJsonOptions()
        );
      </sky-code-block>
    </li>
  </ol>

  <stache-page-anchor>
    <sky-code>skyAuthHttpOptions</sky-code> options
  </stache-page-anchor>

  <ul>
    <li>
      <sky-code>body</sky-code> — <em>(Optional.)</em> Specifies the body to use when creating <a href="https://angular.io/api/http/Request">a <sky-code>Request</sky-code> instance</a>.
    </li>
    <li>
      <sky-code>headers</sky-code> — <em>(Optional.)</em> Specifies <a href="https://angular.io/api/http/Headers">the <sky-code>Headers</sky-code> instance</a> to attach to <a href="https://angular.io/api/http/Request">the <sky-code>Request</sky-code> instance</a>.
    </li>
    <li>
      <sky-code>observe</sky-code> — <em>(Optional.)</em> Specifies the return type of the observable. The valid options are <sky-code>body</sky-code>, <sky-code>events</sky-code>, and <sky-code>response</sky-code>.
    </li>
    <li>
      <sky-code>params</sky-code> — <em>(Optional.)</em> Specifies the search parameters to include in <a href="https://angular.io/api/http/Request">the <sky-code>Request</sky-code> instance</a>.
    </li>
    <li>
      <sky-code>permissionScope</sky-code> — <em>(Optional.)</em> Specifies permissions for the <sky-code>HttpInterceptor</sky-code> interface to intercept and modify HTTP requests globally. This property accepts <sky-code>string</sky-code> values.
    </li>
    <li>
      <sky-code>reportProgress</sky-code> — <em>(Optional.)</em> Indicates whether to enable tracking of progress events. This property accepts <sky-code>boolean</sky-code> values. <em>(Default: false)</em>
    </li>
    <li>
      <sky-code>responseType</sky-code> — <em>(Optional.)</em> Specifies how to parse a successful response body. The valid options are <sky-code>arraybuffer</sky-code>, <sky-code>blob</sky-code>, <sky-code>json</sky-code>, and <sky-code>text</sky-code>. <em>(Default: json)</em>
    </li>
    <li>
      <sky-code>withCredentials</sky-code> — <em>(Optional.)</em> Indicates whether to enable use credentials for <a href="https://angular.io/api/http/Request">the <sky-code>Request</sky-code> instance</a>. This property accepts <sky-code>boolean</sky-code> values. <em>(Default: false)</em>
    </li>
  </ul>

  <stache-page-anchor>
    Unit testing services with <sky-code>SkyAuthHttpClientTestingModule</sky-code>
  </stache-page-anchor>

  In conjunction with Angular's <sky-code>HttpClientTestingModule</sky-code>, <sky-code>SkyAuthHttpClientTestingModule</sky-code> enables unit testing Angular services that make authenticated calls to Blackbaud web services.

  <ol>
    <li>
      <p>
        Add the required imports to the spec file.
      </p>
      <sky-code-block languageType="typescript">
        import {
          fakeAsync,
          getTestBed,
          TestBed,
          tick
        } from '@angular/core/testing';

        import {
          HttpClientTestingModule,
          HttpTestingController
        } from '@angular/common/http/testing';

        import {
          SkyAuthHttpClientTestingModule,
          SkyAuthHttpTestingController
        } from '@skyux/http/testing';

        import {
          FooService
        } from './foo.service';
      </sky-code-block>
    </li>
    <li>
      <p>
        Import <sky-code>HttpClientTestingModule</sky-code> and <sky-code>SkyAuthHttpClientTestingModule</sky-code> into your <sky-code>TestBed</sky-code>, then store the mock controllers injected by those modules in local variables.
      </p>

      <sky-code-block languageType="typescript">
        describe(('Foo service') => {
          let httpMock: HttpTestingController;
          let authMock: SkyAuthHttpTestingController;
          let svc: FooService;

          beforeEach(() => {
            TestBed.configureTestingModule({
              imports: [
                SkyAuthHttpClientTestingModule,
                HttpClientTestingModule
              ],
              providers: [
                FooService
              ]
            });

            const injector = getTestBed();

            httpMock = injector.get(HttpTestingController);
            authMock = injector.get(SkyAuthHttpTestingController);
            svc = injector.get(FooService);
          });

        });
      </sky-code-block>
    </li>
    <li>
      <p>
        Write a test that validates that the service makes an authenticated call to the epxected endpoint. Due to how <sky-code>SkyAuthHttpClientModule</sky-code> provides an HTTP interceptor to asynchronously retrieve a Blackbaud ID token and append it to the request, tests must be run in Angular's fake async zone, and <sky-code>tick()</sky-code> must be called to flush the pending <sky-code>Promise</sky-code> before validating the request.
      </p>

      <sky-code-block languageType="typescript">
        it('should call the expected endpoint', fakeAsync(() => {
          svc.getData().subscribe();

          tick();

          const request = httpMock.expectOne('https://example.com/my/api/endoint');

          authMock.expectAuth(request);

          request.flush({});

          httpMock.verify();
        }));
      </sky-code-block>
    </li>
  </ol>
</stache>
